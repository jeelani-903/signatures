<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Seapol Chatbot</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <h1>Hello this is the new chatbot of Seapol group of companies</h1>

  <div class="chatbot-icon" id="chatbot-icon" onclick="toggleChat()">
    <img src="{{ url_for('static', filename='ship_avatar.png') }}" alt="Ship Avatar" class="icon-avatar" />
  </div>

  <div class="chat-container" id="chat-container">
    <div class="chat-header">
      <div class="chat-header-title">
        <img src="{{ url_for('static', filename='ship_avatar.png') }}" alt="Avatar" class="header-avatar" />
        <div class="chatbot-text-group">
          <span class="chatbot-name">Seapol Chatbot</span>
          <div class="online-status"><span class="status-dot"></span> Online</div>
        </div>
      </div>
      <button onclick="toggleChat()">âœ–</button>
    </div>

    <div class="chat-box" id="chat-box">
      <div class="bot-message">ðŸ‘‹ Welcome! How can I assist you?</div>
      <button onclick="sendMessage('Want to know about our Seapol')">Want to know about our Seapol</button>
      <button onclick="sendMessage('Any questions or FAQ\'s about our company')">Any questions or FAQ's about our company</button>
      <button onclick="sendMessage('Track your goods with AWB number')">Track your goods with AWB number</button>
      <button onclick="sendMessage('Services that are provided by Seapol')">Services that are provided by Seapol</button>
    </div>

    <div class="chat-input">
      <input type="text" id="user-input" placeholder="Type your message..." />
      <button onclick="sendCustomMessage()" class="send-button" aria-label="Send">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="white" viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/></svg>
      </button>
    </div>
  </div>

<script>
  function toggleChat() {
    document.getElementById("chat-container").classList.toggle("visible");
  }

  async function sendMessage(message) {
    const chatBox = document.getElementById("chat-box");
    chatBox.insertAdjacentHTML("beforeend", `<div class="user-message">${message}</div>`);

    const typing = document.createElement("div");
    typing.className = "bot-message typing";
    typing.innerHTML = `<img src="{{ url_for('static', filename='ship_avatar.png') }}" alt="Avatar" class="typing-avatar" />
                        <span class="dot"></span><span class="dot"></span><span class="dot"></span>`;
    chatBox.appendChild(typing);
    chatBox.scrollTop = chatBox.scrollHeight;

    const response = await fetch("/chatbot", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ user_input: message })
    });

    const data = await response.json();
    typing.remove();

    if (data.redirect) {
      window.location.href = data.redirect;
    } else if (data.buttons) {
      data.buttons.forEach(btn => {
        chatBox.insertAdjacentHTML("beforeend", `<button onclick="sendMessage('${btn}')">${btn}</button>`);
      });
    } else if (data.locations) {
      data.locations.forEach(location => {
        chatBox.insertAdjacentHTML("beforeend", `<div class="bot-message location-block">${location}</div>`);
      });
    } else if (data.response) {
      chatBox.insertAdjacentHTML("beforeend", `<div class="bot-message">${escapeHtml(data.response)}</div>`);
    }

    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function sendCustomMessage() {
    const input = document.getElementById("user-input");
    const message = input.value.trim();
    if (message) {
      sendMessage(message);
      input.value = "";
    }
  }

  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, function (m) {
      return {
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
      }[m];
    });
  }

  window.onload = () => {
    fetch('/reset_session', { method: 'POST' });
    setTimeout(() => {
      document.getElementById("chat-container").classList.add("visible");
    }, 4000);
  };

  document.getElementById("user-input").addEventListener("keypress", e => {
    if (e.key === "Enter") {
      e.preventDefault();
      sendCustomMessage();
    }
  });
</script>
</body>
</html>
